
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../iam/">
      
      
        <link rel="next" href="../multitenancy/">
      
      
      <link rel="icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Pod安全 - EKS 最佳实践指南</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-VQGL8B2FH8"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-VQGL8B2FH8",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-VQGL8B2FH8",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pod" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../../" title="EKS 最佳实践指南" class="md-header__button md-logo" aria-label="EKS 最佳实践指南" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            EKS 最佳实践指南
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pod安全
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../../../security/docs/pods/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../../../ko/security/docs/pods/" hreflang="ko" class="md-select__link">
              한국어
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              简体中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/walkley/aws-eks-best-practices" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../" title="EKS 最佳实践指南" class="md-nav__button md-logo" aria-label="EKS 最佳实践指南" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    EKS 最佳实践指南
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/walkley/aws-eks-best-practices" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    aws/aws-eks-best-practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    指南
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            指南
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    介绍
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    安全
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            安全
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../iam/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    身份和访问管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Pod安全
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Pod安全
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Linux 功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点授权
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pod_1" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全解决方案
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pod 安全解决方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-psp" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全策略 (PSP)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_2" class="md-nav__link">
    <span class="md-ellipsis">
      迁移到新的 pod 安全解决方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pac" class="md-nav__link">
    <span class="md-ellipsis">
      策略即代码 (PAC)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-pss-pod-psa" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全标准 (PSS) 和 Pod 安全准入 (PSA)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pod 安全标准 (PSS) 和 Pod 安全准入 (PSA)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod_3" class="md-nav__link">
    <span class="md-ellipsis">
      现有 Pod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      豁免
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_4" class="md-nav__link">
    <span class="md-ellipsis">
      在策略即代码和 Pod 安全标准之间做出选择
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在策略即代码和 Pod 安全标准之间做出选择">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod_5" class="md-nav__link">
    <span class="md-ellipsis">
      策略即代码(与 Pod 安全标准相比)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_6" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全准入(与策略即代码相比)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      建议
    </span>
  </a>
  
    <nav class="md-nav" aria-label="建议">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-psa" class="md-nav__link">
    <span class="md-ellipsis">
      为获得更好的用户体验，使用多个 Pod 安全准入 (PSA) 模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      限制可以以特权模式运行的容器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root" class="md-nav__link">
    <span class="md-ellipsis">
      不要以 root 身份在容器中运行进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-docker" class="md-nav__link">
    <span class="md-ellipsis">
      永远不要在 Docker 中运行 Docker 或在容器中挂载套接字
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hostpath-hostpath" class="md-nav__link">
    <span class="md-ellipsis">
      限制 hostPath 的使用，或者如果必须使用 hostPath，则限制可以使用的前缀并将卷配置为只读
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dos" class="md-nav__link">
    <span class="md-ellipsis">
      为每个容器设置请求和限制，以避免资源争用和 DoS 攻击
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      不要允许特权升级
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serviceaccount" class="md-nav__link">
    <span class="md-ellipsis">
      禁用 ServiceAccount 令牌挂载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      禁用服务发现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      将您的镜像配置为只读根文件系统
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      工具和资源
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multitenancy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    多租户
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../detective/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    检测控制
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../network/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据加密与密钥管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runtime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运行时安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../hosts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础设施安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../compliance/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    合规
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../incidents/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    事件响应和取证
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    镜像安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiaccount/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi Account Strategy
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    集群自动扩缩容
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            集群自动扩缩容
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../karpenter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Karpenter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cluster-autoscaling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster Autoscaler
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可靠性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            可靠性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    应用程序
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/controlplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reliability/docs/dataplane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据平面
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Windows容器
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Windows容器
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/ami/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMI 管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/gmsa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows容器的gMSA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/hardening/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows服务器加固
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/images/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    扫描Windows镜像
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/licensing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows版本与许可
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    日志
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    监控Windows容器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/oom/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存和系统管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/patching/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础设施管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/security/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows容器的安全
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../windows/docs/storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存储选项
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    网络
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/subnets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    VPC和子网注意事项
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/vpc-cni/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Amazon VPC CNI
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/ip-optimization-strategies/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Optimizing IP Address Utilization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/ipv6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    运行IPv6集群
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/custom-networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    自定义网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/prefix-mode/index_linux/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linux的Prefix模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/prefix-mode/index_windows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Windows的Prefix模式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/sgpp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pod级别的安全组
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/loadbalancing/loadbalancing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    负载均衡
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../networking/monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    监控网络性能问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    可扩展性
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            可扩展性
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/control-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/data-plane/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数据平面
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/cluster-services/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    集群服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/workloads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    工作负载
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/scaling_theory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    扩展背后的理论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/kcp_monitoring/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    控制平面监控
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/node_efficiency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    节点效率与扩缩容
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/kubernetes_slos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kubernetes SLOs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../scalability/docs/quotas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Known limits and service quotas
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../upgrades/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    集群升级
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    成本优化
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            成本优化
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cfm_framework/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    云财务管理框架
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_compute/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    计算
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_networking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    网络
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    存储
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../cost_optimization/cost_opt_observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    可观测性
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Linux 功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点授权
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pod_1" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全解决方案
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pod 安全解决方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-psp" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全策略 (PSP)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_2" class="md-nav__link">
    <span class="md-ellipsis">
      迁移到新的 pod 安全解决方案
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pac" class="md-nav__link">
    <span class="md-ellipsis">
      策略即代码 (PAC)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod-pss-pod-psa" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全标准 (PSS) 和 Pod 安全准入 (PSA)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pod 安全标准 (PSS) 和 Pod 安全准入 (PSA)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod_3" class="md-nav__link">
    <span class="md-ellipsis">
      现有 Pod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      豁免
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_4" class="md-nav__link">
    <span class="md-ellipsis">
      在策略即代码和 Pod 安全标准之间做出选择
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在策略即代码和 Pod 安全标准之间做出选择">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod_5" class="md-nav__link">
    <span class="md-ellipsis">
      策略即代码(与 Pod 安全标准相比)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pod_6" class="md-nav__link">
    <span class="md-ellipsis">
      Pod 安全准入(与策略即代码相比)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      建议
    </span>
  </a>
  
    <nav class="md-nav" aria-label="建议">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pod-psa" class="md-nav__link">
    <span class="md-ellipsis">
      为获得更好的用户体验，使用多个 Pod 安全准入 (PSA) 模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      限制可以以特权模式运行的容器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root" class="md-nav__link">
    <span class="md-ellipsis">
      不要以 root 身份在容器中运行进程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-docker" class="md-nav__link">
    <span class="md-ellipsis">
      永远不要在 Docker 中运行 Docker 或在容器中挂载套接字
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hostpath-hostpath" class="md-nav__link">
    <span class="md-ellipsis">
      限制 hostPath 的使用，或者如果必须使用 hostPath，则限制可以使用的前缀并将卷配置为只读
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dos" class="md-nav__link">
    <span class="md-ellipsis">
      为每个容器设置请求和限制，以避免资源争用和 DoS 攻击
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      不要允许特权升级
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serviceaccount" class="md-nav__link">
    <span class="md-ellipsis">
      禁用 ServiceAccount 令牌挂载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      禁用服务发现
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      将您的镜像配置为只读根文件系统
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      工具和资源
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="pod">Pod 安全性<a class="headerlink" href="#pod" title="Permanent link">&para;</a></h1>
<p>Pod 规范包括各种不同的属性，可以加强或削弱您的整体安全态势。作为 Kubernetes 从业人员，您的主要关注点应该是防止在容器运行时中运行的进程逃离容器隔离边界并获得对底层主机的访问权限。</p>
<h2 id="linux">Linux 功能<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h2>
<p>默认情况下，在容器中运行的进程在 [Linux] 根用户的上下文中运行。尽管根在容器内的操作部分受到容器运行时分配给容器的 Linux 功能集的约束，但这些默认权限可能允许攻击者升级他们的权限和/或访问绑定到主机的敏感信息，包括 Secret 和 ConfigMap。下面是分配给容器的默认功能列表。有关每个功能的更多信息，请参阅 <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a>。</p>
<p><code>CAP_AUDIT_WRITE, CAP_CHOWN, CAP_DAC_OVERRIDE, CAP_FOWNER, CAP_FSETID, CAP_KILL, CAP_MKNOD, CAP_NET_BIND_SERVICE, CAP_NET_RAW, CAP_SETGID, CAP_SETUID, CAP_SETFCAP, CAP_SETPCAP, CAP_SYS_CHROOT</code></p>
<div class="admonition 信息">
<p class="admonition-title">信息</p>
</div>
<p>EC2 和 Fargate pod 默认分配了上述功能。此外，只能从 Fargate pod 中删除 Linux 功能。</p>
<p>以特权模式运行的 Pod 继承了主机上与 root 相关的所有 Linux 功能。如果可能的话，应该避免这种情况。</p>
<h3 id="_1">节点授权<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<p>所有 Kubernetes 工作节点都使用一种称为 <a href="https://kubernetes.io/docs/reference/access-authn-authz/node/">节点授权</a> 的授权模式。节点授权允许来自 kubelet 的所有 API 请求，并允许节点执行以下操作：</p>
<p>读取操作：</p>
<ul>
<li>服务</li>
<li>端点</li>
<li>节点</li>
<li>pod</li>
<li>与绑定到 kubelet 节点的 pod 相关的 secret、configmap、持久卷声明和持久卷</li>
</ul>
<p>写入操作：</p>
<ul>
<li>节点和节点状态(启用 <code>NodeRestriction</code> 准入插件以限制 kubelet 仅修改自己的节点)</li>
<li>pod 和 pod 状态(启用 <code>NodeRestriction</code> 准入插件以限制 kubelet 仅修改绑定到自身的 pod)</li>
<li>事件</li>
</ul>
<p>与身份验证相关的操作：</p>
<ul>
<li>读/写访问 CertificateSigningRequest (CSR) API 以进行 TLS 引导</li>
<li>创建 TokenReview 和 SubjectAccessReview 的能力，用于委托身份验证/授权检查</li>
</ul>
<p>EKS 使用 <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction">节点限制准入控制器</a>,它只允许节点修改有限的节点属性和绑定到该节点的 pod 对象。然而，如果攻击者设法访问主机，他们仍然可以从 Kubernetes API 获取有关环境的敏感信息，从而允许他们在集群内进行横向移动。</p>
<h2 id="pod_1">Pod 安全解决方案<a class="headerlink" href="#pod_1" title="Permanent link">&para;</a></h2>
<h3 id="pod-psp">Pod 安全策略 (PSP)<a class="headerlink" href="#pod-psp" title="Permanent link">&para;</a></h3>
<p>过去，使用 <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod 安全策略 (PSP)</a> 资源来指定 pod 在创建之前必须满足的一组要求。从 Kubernetes 版本 1.21 开始，PSP 已被弃用。它们计划在 Kubernetes 版本 1.25 中被删除。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p><a href="https://kubernetes.io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/">PSP 在 Kubernetes 版本 1.21 中已被弃用</a>。您将有大约 2 年的时间来过渡到替代方案，直到版本 1.25。<a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-auth/2579-psp-replacement/README.md#motivation">这个文档</a>解释了弃用 PSP 的动机。</p>
<h3 id="pod_2">迁移到新的 pod 安全解决方案<a class="headerlink" href="#pod_2" title="Permanent link">&para;</a></h3>
<p>由于 PSP 在 Kubernetes v1.25 中已被删除，集群管理员和操作员必须用其他安全控制来替换。两种解决方案可以满足这种需求：</p>
<ul>
<li>Kubernetes 生态系统中的策略即代码 (PAC) 解决方案</li>
<li>Kubernetes <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/">Pod 安全标准 (PSS)</a></li>
</ul>
<p>PAC 和 PSS 解决方案都可以与 PSP 共存;在 PSP 被删除之前，它们可以在集群中使用。这有助于在从 PSP 迁移时采用。在考虑从 PSP 迁移到 PSS 时，请参阅<a href="https://kubernetes.io/docs/tasks/configure-pod-container/migrate-from-psp/">此文档</a>。</p>
<p>Kyverno 是下面概述的 PAC 解决方案之一，在<a href="https://kyverno.io/blog/2023/05/24/podsecuritypolicy-migration-with-kyverno/">博客文章</a>中概述了从 PSP 迁移到其解决方案的具体指导，包括类似的策略、功能比较和迁移程序。关于使用 Kyverno 迁移到 Pod 安全准入 (PSA) 的更多信息和指导已在 AWS 博客 <a href="https://aws.amazon.com/blogs/containers/managing-pod-security-on-amazon-eks-with-kyverno/">此处</a> 发布。</p>
<h3 id="pac">策略即代码 (PAC)<a class="headerlink" href="#pac" title="Permanent link">&para;</a></h3>
<p>策略即代码 (PAC) 解决方案提供了保护措施，通过规定和自动化控制来指导集群用户，并防止不希望的行为。PAC 使用 <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">Kubernetes 动态准入控制器</a>通过 webhook 调用拦截 Kubernetes API 服务器请求流，并根据以代码形式编写和存储的策略对请求负载进行变更和验证。变更和验证发生在 API 服务器请求导致集群发生更改之前。PAC 解决方案使用策略来匹配和处理 API 服务器请求负载，基于分类和值。</p>
<p>Kubernetes 生态系统中有几种开源 PAC 解决方案可用。这些解决方案不是 Kubernetes 项目的一部分;它们来自 Kubernetes 生态系统。下面列出了一些 PAC 解决方案。</p>
<ul>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/docs/">OPA/Gatekeeper</a></li>
<li><a href="https://www.openpolicyagent.org/">Open Policy Agent (OPA)</a></li>
<li><a href="https://kyverno.io/">Kyverno</a></li>
<li><a href="https://www.kubewarden.io/">Kubewarden</a></li>
<li><a href="https://www.jspolicy.com/">jsPolicy</a></li>
</ul>
<p>有关 PAC 解决方案的更多信息以及如何帮助您选择适合您需求的合适解决方案，请参阅下面的链接。</p>
<ul>
<li><a href="https://aws.amazon.com/blogs/containers/policy-based-countermeasures-for-kubernetes-part-1/">Kubernetes 的基于策略的对策 – 第 1 部分</a></li>
<li><a href="https://aws.amazon.com/blogs/containers/policy-based-countermeasures-for-kubernetes-part-2/">Kubernetes 的基于策略的对策 – 第 2 部分</a></li>
</ul>
<h3 id="pod-pss-pod-psa">Pod 安全标准 (PSS) 和 Pod 安全准入 (PSA)<a class="headerlink" href="#pod-pss-pod-psa" title="Permanent link">&para;</a></h3>
<p>为了应对 PSP 弃用和对开箱即用的 Kubernetes 内置解决方案控制 pod 安全性的持续需求，Kubernetes <a href="https://github.com/kubernetes/community/tree/master/sig-auth">Auth 特别兴趣小组</a>创建了 <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/">Pod 安全标准 (PSS)</a> 和 <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">Pod 安全准入 (PSA)</a>。PSA 工作包括一个 <a href="https://github.com/kubernetes/pod-security-admission#pod-security-admission">准入控制器 webhook 项目</a>,它实现了 PSS 中定义的控制。这种准入控制器方法类似于 PAC 解决方案中使用的方法。</p>
<p>根据 Kubernetes 文档，PSS <em>"定义了三种不同的策略，广泛涵盖了安全范围。这些策略是累积的，范围从高度宽松到高度限制。"</em></p>
<p>这些策略定义如下：</p>
<ul>
<li>
<p><strong>特权：</strong> 不受限制(不安全)的策略，提供最广泛的权限级别。此策略允许已知的权限升级。这是没有策略的情况。这对于需要特权访问的应用程序(如日志代理、CNI、存储驱动程序和其他系统范围的应用程序)很有用。</p>
</li>
<li>
<p><strong>基线：</strong> 最小限制性策略，可防止已知的权限升级。允许默认(最小指定)的 Pod 配置。基线策略禁止使用 hostNetwork、hostPID、hostIPC、hostPath、hostPort,无法添加 Linux 功能，以及其他几个限制。</p>
</li>
<li>
<p><strong>受限：</strong> 高度限制的策略，遵循当前的 Pod 强化最佳实践。该策略继承自基线并添加了进一步的限制，例如无法以 root 或 root 组身份运行。受限策略可能会影响应用程序的功能。它们主要针对运行安全关键应用程序。</p>
</li>
</ul>
<p>这些策略定义了 <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/#profile-details">pod 执行配置文件</a>,分为三个特权与受限访问级别。</p>
<p>为了实现 PSS 定义的控制，PSA 以三种模式运行：</p>
<ul>
<li>
<p><strong>enforce:</strong> 违反策略将导致 pod 被拒绝。</p>
</li>
<li>
<p><strong>audit:</strong> 违反策略将触发在审计日志中添加审计注释到记录的事件，但其他情况下允许。</p>
</li>
<li>
<p><strong>warn:</strong> 违反策略将触发面向用户的警告，但其他情况下允许。</p>
</li>
</ul>
<p>这些模式和配置文件(限制)级别使用标签在 Kubernetes 命名空间级别进行配置，如下例所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-test</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
</code></pre></div>
<p>当单独使用时，这些操作模式会产生不同的响应，从而导致不同的用户体验。<em>enforce</em> 模式将阻止创建违反配置限制级别的 pod。但是，在这种模式下，创建 pod 的非 pod Kubernetes 对象(如 Deployment)将不会被阻止应用到集群，即使其中的 podSpec 违反了应用的 PSS。在这种情况下，Deployment 将被应用，而 pod 将被阻止应用。</p>
<p>这是一种困难的用户体验，因为没有立即的迹象表明成功应用的 Deployment 对象掩盖了 pod 创建失败。违规的 podSpec 将不会创建 pod。使用 <code>kubectl get deploy &lt;DEPLOYMENT_NAME&gt; -oyaml</code> 检查 Deployment 资源将暴露失败 pod 的 <code>.status.conditions</code> 元素中的消息，如下所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nn">...</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="nt">status</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">  </span><span class="nt">conditions</span><span class="p">:</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">lastTransitionTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2022-01-20T01:02:08Z&quot;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">      </span><span class="nt">lastUpdateTime</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2022-01-20T01:02:08Z&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">      </span><span class="nt">message</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;pods</span><span class="nv"> </span><span class="s">&quot;test-688f68dc87-tw587&quot;</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">forbidden:</span><span class="nv"> </span><span class="s">violates</span><span class="nv"> </span><span class="s">PodSecurity</span><span class="nv"> </span><span class="s">&quot;restricted:latest&quot;:</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">        </span><span class="s">allowPrivilegeEscalation</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">false</span><span class="nv"> </span><span class="s">(container</span><span class="nv"> </span><span class="s">&quot;test&quot;</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">securityContext.allowPrivilegeEscalation=false),</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">        </span><span class="s">unrestricted</span><span class="nv"> </span><span class="s">capabilities</span><span class="nv"> </span><span class="s">(container</span><span class="nv"> </span><span class="s">&quot;test&quot;</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">securityContext.capabilities.drop=[&quot;ALL&quot;]),</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">        </span><span class="s">runAsNonRoot</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">true</span><span class="nv"> </span><span class="s">(pod</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">container</span><span class="nv"> </span><span class="s">&quot;test&quot;</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">securityContext.runAsNonRoot=true),</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w">        </span><span class="s">seccompProfile</span><span class="nv"> </span><span class="s">(pod</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">container</span><span class="nv"> </span><span class="s">&quot;test&quot;</span><span class="nv"> </span><span class="s">must</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">securityContext.seccompProfile.type</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">        </span><span class="s">to</span><span class="nv"> </span><span class="s">&quot;RuntimeDefault&quot;</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">&quot;Localhost&quot;)&#39;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">      </span><span class="nt">reason</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FailedCreate</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;True&quot;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaFailure</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="nn">...</span>
</code></pre></div>
<p>在 <em>audit</em> 和 <em>warn</em> 模式下，pod 限制不会阻止违规 pod 被创建和启动。但是，在这些模式下，当 pod 以及创建 pod 的对象包含违规 podSpec 时，会分别触发 API 服务器审计日志事件的审计注释和向 API 服务器客户端(如 <em>kubectl</em>)发出警告。下面是 <code>kubectl</code> <em>Warning</em> 消息。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>Warning:<span class="w"> </span>would<span class="w"> </span>violate<span class="w"> </span>PodSecurity<span class="w"> </span><span class="s2">&quot;restricted:latest&quot;</span>:<span class="w"> </span>allowPrivilegeEscalation<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="w"> </span><span class="o">(</span>container<span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="w"> </span>must<span class="w"> </span><span class="nb">set</span><span class="w"> </span>securityContext.allowPrivilegeEscalation<span class="o">=</span><span class="nb">false</span><span class="o">)</span>,<span class="w"> </span>unrestricted<span class="w"> </span>capabilities<span class="w"> </span><span class="o">(</span>container<span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="w"> </span>must<span class="w"> </span><span class="nb">set</span><span class="w"> </span>securityContext.capabilities.drop<span class="o">=[</span><span class="s2">&quot;ALL&quot;</span><span class="o">])</span>,<span class="w"> </span>runAsNonRoot<span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">(</span>pod<span class="w"> </span>or<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="w"> </span>must<span class="w"> </span><span class="nb">set</span><span class="w"> </span>securityContext.runAsNonRoot<span class="o">=</span><span class="nb">true</span><span class="o">)</span>,<span class="w"> </span>seccompProfile<span class="w"> </span><span class="o">(</span>pod<span class="w"> </span>or<span class="w"> </span>container<span class="w"> </span><span class="s2">&quot;test&quot;</span><span class="w"> </span>must<span class="w"> </span><span class="nb">set</span><span class="w"> </span>securityContext.seccompProfile.type<span class="w"> </span>to<span class="w"> </span><span class="s2">&quot;RuntimeDefault&quot;</span><span class="w"> </span>or<span class="w"> </span><span class="s2">&quot;Localhost&quot;</span><span class="o">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>deployment.apps/test<span class="w"> </span>created
</code></pre></div>
<p>PSA <em>audit</em> 和 <em>warn</em> 模式在引入 PSS 时不会对集群操作产生负面影响，因此很有用。</p>
<p>PSA 操作模式不是互斥的，可以以累积的方式使用。如下所示，多个模式可以在单个命名空间中配置。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-test</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/audit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/warn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
</code></pre></div>
<p>在上面的示例中，在应用 Deployment 时提供了友好的警告和审计注释，同时还提供了违规的强制执行。事实上，多个 PSA 标签可以使用不同的配置文件级别，如下所示。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-test</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">baseline</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/warn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
</code></pre></div>
<p>在上面的示例中，PSA 被配置为允许创建满足 <em>baseline</em> 配置文件级别的所有 pod，然后对违反 <em>restricted</em> 配置文件级别的 pod(和创建 pod 的对象)发出警告。这是一种有用的方法，可以确定从 <em>baseline</em> 到 <em>restricted</em> 配置文件时可能产生的影响。</p>
<h4 id="pod_3">现有 Pod<a class="headerlink" href="#pod_3" title="Permanent link">&para;</a></h4>
<p>如果使用更严格的 PSS 配置文件修改了包含现有 pod 的命名空间，<em>audit</em> 和 <em>warn</em> 模式将产生适当的消息;但是，<em>enforce</em> 模式不会删除 pod。下面是警告消息。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>Warning:<span class="w"> </span>existing<span class="w"> </span>pods<span class="w"> </span><span class="k">in</span><span class="w"> </span>namespace<span class="w"> </span><span class="s2">&quot;policy-test&quot;</span><span class="w"> </span>violate<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>PodSecurity<span class="w"> </span>enforce<span class="w"> </span>level<span class="w"> </span><span class="s2">&quot;restricted:latest&quot;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>Warning:<span class="w"> </span>test-688f68dc87-htm8x:<span class="w"> </span>allowPrivilegeEscalation<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>false,<span class="w"> </span>unrestricted<span class="w"> </span>capabilities,<span class="w"> </span>runAsNonRoot<span class="w"> </span>!<span class="o">=</span><span class="w"> </span>true,<span class="w"> </span>seccompProfile
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>namespace/policy-test<span class="w"> </span>configured
</code></pre></div>
<h4 id="_2">豁免<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<p>PSA 使用 <em>Exemptions</em> 来排除对本应应用的 pod 的违规执行。这些豁免如下所列。</p>
<ul>
<li>
<p><strong>用户名：</strong> 来自具有豁免的经过身份验证(或模拟)用户名的请求将被忽略。</p>
</li>
<li>
<p><strong>RuntimeClassName:</strong> 指定了豁免的运行时类名的 pod 和工作负载资源将被忽略。</p>
</li>
<li>
<p><strong>命名空间：</strong> 位于豁免命名空间中的 pod 和工作负载资源将被忽略。</p>
</li>
</ul>
<p>这些豁免作为 API 服务器配置的一部分静态应用于 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/enforce-standards-admission-controller/#configure-the-admission-controller">PSA 准入控制器配置</a>。</p>
<p>在 <em>Validating Webhook</em> 实现中，豁免可以在 Kubernetes <a href="https://github.com/kubernetes/pod-security-admission/blob/master/webhook/manifests/20-configmap.yaml">ConfigMap</a> 资源中配置，该资源作为卷被挂载到 <a href="https://github.com/kubernetes/pod-security-admission/blob/master/webhook/manifests/50-deployment.yaml">pod-security-webhook</a> 容器中。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-security-webhook</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-security-webhook</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="nt">podsecurityconfiguration.yaml</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="no">apiVersion: pod-security.admission.config.k8s.io/v1</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">    </span><span class="no">kind: PodSecurityConfiguration</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">    </span><span class="no">defaults:</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">      </span><span class="no">enforce: &quot;restricted&quot;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">      </span><span class="no">enforce-version: &quot;latest&quot;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">      </span><span class="no">audit: &quot;restricted&quot;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">      </span><span class="no">audit-version: &quot;latest&quot;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">      </span><span class="no">warn: &quot;restricted&quot;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">      </span><span class="no">warn-version: &quot;latest&quot;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">    </span><span class="no">exemptions:</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">      </span><span class="no"># Array of authenticated usernames to exempt.</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">      </span><span class="no">usernames: []</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">      </span><span class="no"># Array of runtime class names to exempt.</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">      </span><span class="no">runtimeClasses: []</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">      </span><span class="no"># Array of namespaces to exempt.</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">      </span><span class="no">namespaces: [&quot;kube-system&quot;,&quot;policy-test1&quot;]</span>
</code></pre></div>
<p>如上面的 ConfigMap YAML 所示，已将集群范围的默认 PSS 级别设置为所有 PSA 模式(<em>audit</em>、<em>enforce</em> 和 <em>warn</em>)的 <em>restricted</em>。这影响所有命名空间，除了那些被豁免的命名空间： <code>namespaces: ["kube-system","policy-test1"]</code>。此外，在下面的 <em>ValidatingWebhookConfiguration</em> 资源中，<em>pod-security-webhook</em> 命名空间也被豁免于配置的 PSS。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nn">...</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="nt">webhooks</span><span class="p">:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="c1"># Audit annotations will be prefixed with this name</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pod-security-webhook.kubernetes.io&quot;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">    </span><span class="c1"># Fail-closed admission webhooks can present operational challenges.</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="c1"># You may want to consider using a failure policy of Ignore, but should </span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="c1"># consider the security tradeoffs.</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">    </span><span class="nt">failurePolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fail</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">    </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">      </span><span class="c1"># Exempt the webhook itself to avoid a circular dependency.</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">      </span><span class="nt">matchExpressions</span><span class="p">:</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/metadata.name</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">          </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NotIn</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">          </span><span class="nt">values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;pod-security-webhook&quot;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="nn">...</span>
</code></pre></div>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>Pod 安全准入在 Kubernetes v1.25 中已经毕业为稳定版本。如果您想在默认启用该功能之前使用 Pod 安全准入功能，您需要安装动态准入控制器(变更 webhook)。安装和配置 webhook 的说明可以在<a href="https://github.com/kubernetes/pod-security-admission/tree/master/webhook">这里</a>找到。</p>
<h3 id="pod_4">在策略即代码和 Pod 安全标准之间做出选择<a class="headerlink" href="#pod_4" title="Permanent link">&para;</a></h3>
<p>Pod 安全标准 (PSS) 的开发是为了取代 Pod 安全策略 (PSP)，通过提供一个内置于 Kubernetes 的解决方案，而不需要使用来自 Kubernetes 生态系统的解决方案。不过，策略即代码 (PAC) 解决方案要灵活得多。</p>
<p>以下优缺点列表旨在帮助您就 pod 安全解决方案做出更明智的决定。</p>
<h4 id="pod_5">策略即代码(与 Pod 安全标准相比)<a class="headerlink" href="#pod_5" title="Permanent link">&para;</a></h4>
<p>优点：</p>
<ul>
<li>更灵活、更细粒度(如果需要，可以细化到资源的属性)</li>
<li>不仅仅局限于 pod，可以用于不同的资源和操作</li>
<li>不仅仅在命名空间级别应用</li>
<li>比 Pod 安全标准更成熟</li>
<li>决策可以基于 API 服务器请求负载中的任何内容，以及现有集群资源和外部数据(取决于解决方案)</li>
<li>支持在验证之前变更 API 服务器请求(取决于解决方案)</li>
<li>可以生成补充策略和 Kubernetes 资源(取决于解决方案 - 从 pod 策略开始，Kyverno 可以 <a href="https://kyverno.io/docs/writing-policies/autogen/">自动生成</a>更高级控制器(如 Deployment)的策略。Kyverno 还可以通过使用 <a href="https://kyverno.io/docs/writing-policies/generate/">Generate Rules</a> 在创建新资源或更新源时生成其他 Kubernetes 资源。)</li>
<li>可以向左移动，进入 CICD 管道，在调用 Kubernetes API 服务器之前(取决于解决方案)</li>
<li>可以用于实现与安全无关的行为，例如最佳实践、组织标准等</li>
<li>可以在非 Kubernetes 用例中使用(取决于解决方案)</li>
<li>由于灵活性，用户体验可以根据用户需求进行调整</li>
</ul>
<p>缺点：</p>
<ul>
<li>不是内置于 Kubernetes 中</li>
<li>更复杂，学习、配置和支持都更加困难</li>
<li>编写策略可能需要新的技能/语言/能力</li>
</ul>
<h4 id="pod_6">Pod 安全准入(与策略即代码相比)<a class="headerlink" href="#pod_6" title="Permanent link">&para;</a></h4>
<p>优点：</p>
<ul>
<li>内置于 Kubernetes 中</li>
<li>配置更简单</li>
<li>无需使用新语言或编写策略</li>
<li>如果集群默认准入级别配置为 <em>privileged</em>，则可以使用命名空间标签将命名空间选入 pod 安全配置文件。</li>
</ul>
<p>缺点：</p>
<ul>
<li>不如策略即代码那么灵活或细粒度</li>
<li>只有 3 个限制级别</li>
<li>主要关注 pod</li>
</ul>
<h4 id="_3">总结<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p>如果您目前还没有除 PSP 之外的 pod 安全解决方案，并且您所需的 pod 安全态势符合 Pod 安全标准 (PSS) 定义的模型，那么采用 PSS 而不是策略即代码解决方案可能是一条更简单的路径。但是，如果您的 pod 安全态势不符合 PSS 模型，或者您预计将添加超出 PSS 定义范围的其他控制，那么策略即代码解决方案似乎更合适。</p>
<h2 id="_4">建议<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="pod-psa">为获得更好的用户体验，使用多个 Pod 安全准入 (PSA) 模式<a class="headerlink" href="#pod-psa" title="Permanent link">&para;</a></h3>
<p>如前所述，PSA <em>enforce</em> 模式可以防止违反 PSS 的 pod 被应用，但不会阻止更高级别的控制器(如 Deployment)。事实上，Deployment 将被成功应用，而没有任何迹象表明 pod 未能被应用。虽然您可以使用 <em>kubectl</em> 检查 Deployment 对象，并发现来自 PSA 的失败 pod 消息，但用户体验可以更好。为了改善用户体验，应该使用多个 PSA 模式(audit、enforce、warn)。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-test</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/audit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/enforce</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">    </span><span class="nt">pod-security.kubernetes.io/warn</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restricted</span>
</code></pre></div>
<p>在上面的示例中，定义了 <em>enforce</em> 模式，当尝试将包含 PSS 违规的 podSpec 的 Deployment 清单应用到 Kubernetes API 服务器时，Deployment 将被成功应用，但 pod 不会。而且，由于 <em>audit</em> 和 <em>warn</em> 模式也已启用，API 服务器客户端将收到警告消息，API 服务器审计日志事件也将被注释消息。</p>
<h3 id="_5">限制可以以特权模式运行的容器<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>如前所述，以特权模式运行的容器继承了主机上与 root 相关的所有 Linux 功能。很少有容器需要这种类型的特权才能正常运行。有多种方法可以用来限制容器的权限和功能。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>Fargate 是一种启动类型，可让您在 AWS 管理的基础设施上运行"无服务器"容器(pod 中的容器)。使用 Fargate，您无法运行特权容器或配置 pod 使用 hostNetwork 或 hostPort。</p>
<h3 id="root">不要以 root 身份在容器中运行进程<a class="headerlink" href="#root" title="Permanent link">&para;</a></h3>
<p>所有容器默认都以 root 身份运行。如果攻击者能够利用应用程序中的漏洞并获得对正在运行的容器的 shell 访问权限，这可能会带来问题。您可以通过多种方式缓解这种风险。首先，从容器镜像中删除 shell。其次，在 Dockerfile 中添加 USER 指令或以非 root 用户身份在 pod 中运行容器。Kubernetes podSpec 包括一组字段，在 <code>spec.securityContext</code> 下，让您可以指定运行应用程序的用户和/或组。这些字段分别是 <code>runAsUser</code> 和 <code>runAsGroup</code>。</p>
<p>要在集群中强制使用 Kubernetes podSpec 中的 <code>spec.securityContext</code> 及其关联元素，可以添加策略即代码或 Pod 安全标准。这些解决方案允许您编写和/或使用策略或配置文件，在将请求负载持久化到 etcd 之前，可以验证传入的 Kubernetes API 服务器请求负载。此外，策略即代码解决方案可以变更传入的请求，在某些情况下还可以生成新的请求。</p>
<h3 id="docker-docker">永远不要在 Docker 中运行 Docker 或在容器中挂载套接字<a class="headerlink" href="#docker-docker" title="Permanent link">&para;</a></h3>
<p>虽然这种方式可以方便地让您在 Docker 容器中构建/运行镜像，但您基本上是在放弃对节点的完全控制权，让在容器中运行的进程来控制。如果您需要在 Kubernetes 上构建容器镜像，请使用 <a href="https://github.com/GoogleContainerTools/kaniko">Kaniko</a>、<a href="https://github.com/containers/buildah">buildah</a> 或构建服务(如 <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/welcome.html">CodeBuild</a>)。</p>
<div class="admonition 提示">
<p class="admonition-title">提示</p>
</div>
<p>用于 CICD 处理(如构建容器镜像)的 Kubernetes 集群应与运行更通用工作负载的集群隔离。</p>
<h3 id="hostpath-hostpath">限制 hostPath 的使用，或者如果必须使用 hostPath，则限制可以使用的前缀并将卷配置为只读<a class="headerlink" href="#hostpath-hostpath" title="Permanent link">&para;</a></h3>
<p><code>hostPath</code> 是一种卷，直接将主机上的目录挂载到容器中。很少有 pod 需要这种类型的访问权限，但如果需要，您需要意识到风险。默认情况下，以 root 身份运行的 pod 将对 hostPath 暴露的文件系统具有写入权限。这可能允许攻击者修改 kubelet 设置、创建指向未直接暴露的目录或文件(例如 /etc/shadow)的符号链接、安装 ssh 密钥、读取挂载到主机的 secret 以及执行其他恶意操作。为了减轻 hostPath 带来的风险，请将 <code>spec.containers.volumeMounts</code> 配置为 <code>readOnly</code>,例如：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nt">volumeMounts</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hostPath-volume</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">readOnly</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/host-path</span>
</code></pre></div>
<p>您还应该使用策略即代码解决方案来限制可以使用 <code>hostPath</code> 卷的目录，或者完全阻止使用 <code>hostPath</code>。您可以使用 Pod 安全标准的 <em>Baseline</em> 或 <em>Restricted</em> 策略来防止使用 <code>hostPath</code>。</p>
<p>有关特权升级的危险性的更多信息，请阅读 Seth Art 的博客 <a href="https://labs.bishopfox.com/tech-blog/bad-pods-kubernetes-pod-privilege-escalation">Bad Pods: Kubernetes Pod Privilege Escalation</a>。</p>
<h3 id="dos">为每个容器设置请求和限制，以避免资源争用和 DoS 攻击<a class="headerlink" href="#dos" title="Permanent link">&para;</a></h3>
<p>没有请求或限制的 pod 理论上可以消耗主机上的所有可用资源。当额外的 pod 被调度到节点时，节点可能会遇到 CPU 或内存压力，这可能会导致 Kubelet 终止或从节点中逐出 pod。虽然您无法完全防止这种情况发生，但设置请求和限制将有助于最小化资源争用并减轻编写不佳的应用程序消耗过多资源的风险。</p>
<p><code>podSpec</code> 允许您为 CPU 和内存指定请求和限制。CPU 被视为可压缩资源，因为它可以过度使用。内存是不可压缩的，即不能在多个容器之间共享。</p>
<p>当您为 CPU 或内存指定 <em>requests</em> 时，您实际上是在指定容器保证获得的 <em>内存</em> 量。Kubernetes 汇总 pod 中所有容器的请求，以确定将 pod 调度到哪个节点。如果容器超过请求的内存量，如果节点上存在内存压力，它可能会被终止。</p>
<p><em>Limits</em> 是容器允许消耗的最大 CPU 和内存资源量，直接对应于为容器创建的 cgroup 的 <code>memory.limit_in_bytes</code> 值。超过内存限制的容器将被 OOM 终止。如果容器超过其 CPU 限制，它将被节流。</p>
<div class="admonition 提示">
<p class="admonition-title">提示</p>
</div>
<p>使用容器 <code>resources.limits</code> 时，强烈建议基于负载测试来确定精确的容器资源使用情况(也称为资源占用)。如果没有准确可信的资源占用，可以适当填充容器 <code>resources.limits</code>。例如，<code>resources.limits.memory</code> 可以比可观察到的最大值高出 20-30%,以考虑潜在的内存资源限制不准确性。</p>
<p>Kubernetes 使用三个服务质量 (QoS) 类来确定在节点上运行的工作负载的优先级。这些包括：</p>
<ul>
<li>guaranteed</li>
<li>burstable</li>
<li>best-effort</li>
</ul>
<p>如果未设置限制和请求，则 pod 被配置为 <em>best-effort</em>(最低优先级)。当内存不足时，best-effort pod 将是第一个被终止的。如果在 pod 内的所有容器上设置了限制，或者请求和限制设置为相同的值且不等于 0，则 pod 被配置为 <em>guaranteed</em>(最高优先级)。guaranteed pod 不会被终止，除非它们超过配置的内存限制。如果限制和请求配置为不同的值且不等于 0，或者 pod 内的一个容器设置了限制而其他容器没有设置或为不同资源设置了限制，则 pod 被配置为 <em>burstable</em>(中等优先级)。这些 pod 有一些资源保证，但一旦超过请求的内存就可能被终止。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>请求不会影响容器 cgroup 的 <code>memory_limit_in_bytes</code> 值;cgroup 限制设置为主机上可用的内存量。但是，如果将请求值设置得太低，当节点遇到内存压力时，kubelet 可能会将 pod 列为终止目标。</p>
<table>
<thead>
<tr>
<th style="text-align: left;">类别</th>
<th style="text-align: left;">优先级</th>
<th style="text-align: left;">条件</th>
<th style="text-align: left;">终止条件</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">Guaranteed</td>
<td style="text-align: left;">最高</td>
<td style="text-align: left;">limit = request != 0</td>
<td style="text-align: left;">仅在超过内存限制时</td>
</tr>
<tr>
<td style="text-align: left;">Burstable</td>
<td style="text-align: left;">中等</td>
<td style="text-align: left;">limit != request != 0</td>
<td style="text-align: left;">如果超过请求内存，可能会被终止</td>
</tr>
<tr>
<td style="text-align: left;">Best-Effort</td>
<td style="text-align: left;">最低</td>
<td style="text-align: left;">limit &amp; request 未设置</td>
<td style="text-align: left;">当内存不足时首先被终止</td>
</tr>
</tbody>
</table>
<p>有关资源 QoS 的更多信息，请参阅 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/">Kubernetes 文档</a>。</p>
<p>您可以通过在命名空间上设置 <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">资源配额</a>或创建 <a href="https://kubernetes.io/docs/concepts/policy/limit-range/">限制范围</a>来强制使用请求和限制。资源配额允许您指定分配给命名空间的总资源量，例如 CPU 和 RAM。当应用到命名空间时，它会强制您为部署到该命名空间的所有容器指定请求和限制。相比之下，限制范围让您可以更精细地控制命名空间内的资源分配。使用限制范围，您可以为 pod 或命名空间内的每个容器设置 CPU 和内存资源的最小/最大值。您还可以使用它们来设置默认的请求/限制值，如果没有提供的话。</p>
<p>策略即代码解决方案可用于强制执行请求和限制，或者在创建命名空间时甚至创建资源配额和限制范围。</p>
<h3 id="_6">不要允许特权升级<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>特权升级允许进程更改其运行的安全上下文。Sudo 就是一个很好的例子，具有 SUID 或 SGID 位的二进制文件也是如此。特权升级基本上是一种让用户以另一个用户或组的权限执行文件的方式。您可以通过实现变更策略即代码策略将 <code>allowPrivilegeEscalation</code> 设置为 <code>false</code>,或者在 <code>podSpec</code> 中设置 <code>securityContext.allowPrivilegeEscalation</code>,来防止容器使用特权升级。策略即代码策略还可以用于防止 API 服务器请求在检测到错误设置时成功。Pod 安全标准也可以用于防止 pod 使用特权升级。</p>
<h3 id="serviceaccount">禁用 ServiceAccount 令牌挂载<a class="headerlink" href="#serviceaccount" title="Permanent link">&para;</a></h3>
<p>对于不需要访问 Kubernetes API 的 pod，您可以在 pod 规范或对于使用特定 ServiceAccount 的所有 pod 上禁用自动挂载 ServiceAccount 令牌。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>禁用 ServiceAccount 挂载并不会阻止 pod 通过网络访问 Kubernetes API。要防止 pod 通过网络访问 Kubernetes API，您需要修改 <a href="https://docs.aws.amazon.com/eks/latest/userguide/cluster-endpoint.html">EKS 集群端点访问</a>并使用 <a href="../network/#network-policy">NetworkPolicy</a> 阻止 pod 访问。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-no-automount</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">  </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sa-no-automount</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<h3 id="_7">禁用服务发现<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>对于不需要查找或调用集群内服务的 pod，您可以减少提供给 pod 的信息量。您可以将 Pod 的 DNS 策略设置为不使用 CoreDNS，并且不将服务暴露为 pod 命名空间中的环境变量。有关服务链接的更多信息，请参阅 <a href="https://kubernetes.io/docs/concepts/services-networking/service/#environment-variables">Kubernetes 关于环境变量的文档</a>。pod 的 DNS 策略的默认值为 "ClusterFirst",它使用集群内 DNS，而非默认值 "Default" 使用底层节点的 DNS 解析。有关更多信息，请参阅 <a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-policy">Kubernetes 关于 Pod DNS 策略的文档</a>。</p>
<div class="admonition 注意">
<p class="admonition-title">注意</p>
</div>
<p>禁用服务链接和更改 pod 的 DNS 策略并不会阻止 pod 通过网络访问集群内 DNS 服务。攻击者仍然可以通过访问集群内 DNS 服务来枚举服务。(例如： <code>dig SRV *.*.svc.cluster.local @$CLUSTER_DNS_IP</code>)要防止集群内服务发现，请使用 <a href="../network/#network-policy">NetworkPolicy</a> 阻止 pod 访问</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="nt">metadata</span><span class="p">:</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod-no-service-info</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="nt">spec</span><span class="p">:</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Default</span><span class="w"> </span><span class="c1"># &quot;Default&quot; 不是真正的默认值</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="nt">enableServiceLinks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
<h3 id="_8">将您的镜像配置为只读根文件系统<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>将您的镜像配置为只读根文件系统可以防止攻击者覆盖您的应用程序使用的文件系统上的二进制文件。如果您的应用程序需要写入文件系统，请考虑写入临时目录或附加并挂载卷。您可以通过设置 pod 的 SecurityContext 来强制执行此操作，如下所示：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nn">...</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="nt">securityContext</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">  </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="nn">...</span>
</code></pre></div>
<p>策略即代码和 Pod 安全标准可用于强制执行此行为。</p>
<div class="admonition 信息">
<p class="admonition-title">信息</p>
</div>
<p>根据 <a href="https://kubernetes.io/docs/concepts/windows/intro/">Kubernetes 中的 Windows 容器</a>,对于在 Windows 上运行的容器，<code>securityContext.readOnlyRootFilesystem</code> 不能设置为 <code>true</code>,因为注册表和系统进程需要在容器内部具有写入访问权限才能运行。</p>
<h2 id="_9">工具和资源<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="https://catalog.workshops.aws/eks-security-immersionday/en-US/3-pod-security">Amazon EKS 安全沉浸式研讨会 - Pod 安全</a></li>
<li><a href="https://github.com/open-policy-agent/gatekeeper-library">open-policy-agent/gatekeeper-library: OPA Gatekeeper 策略库</a>,您可以使用这个库作为 PSP 的替代品。</li>
<li><a href="https://kyverno.io/policies/">Kyverno 策略库</a></li>
<li>一组常见的 OPA 和 Kyverno <a href="https://github.com/aws/aws-eks-best-practices/tree/master/policies">策略</a>用于 EKS。</li>
<li><a href="https://aws.amazon.com/blogs/containers/policy-based-countermeasures-for-kubernetes-part-1/">基于策略的对策：第 1 部分</a></li>
<li><a href="https://aws.amazon.com/blogs/containers/policy-based-countermeasures-for-kubernetes-part-2/">基于策略的对策：第 2 部分</a></li>
<li><a href="https://appvia.github.io/psp-migration/">Pod 安全策略迁移器</a> 一个将 PSP 转换为 OPA/Gatekeeper、KubeWarden 或 Kyverno 策略的工具</li>
<li><a href="https://www.suse.com/neuvector/">NeuVector by SUSE</a> 开源、零信任容器安全平台，提供进程和文件系统策略以及准入控制规则。</li>
</ul>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["tabs", "content.code.copy", "announce.dismiss", "header.autohide"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>